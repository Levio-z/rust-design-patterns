# Rust 异步关闭钩子：基于回调的设计与观察者模式和模板方法模式

本项目演示了如何在 Rust 中使用**回调机制**实现一个**异步关闭钩子系统**，并结合设计模式中的**观察者模式**和**模板方法模式**的思想。

---

## 关键概念与设计模式

### 回调机制

核心思想是每个关闭钩子都是一个**回调函数**——用户注册的异步闭包，在关闭时被调用。钩子被动态存储并触发，实现了扩展性和低耦合。

### 观察者模式

- **主题（Subject）：** `AsyncShutdownHooks` 维护一组已注册的钩子回调（观察者）。
- **观察者（Observers）：** 每个钩子作为观察者响应关闭事件。
- 当收到关闭信号时，所有注册的钩子被异步通知（调用）。

### 模板方法模式（隐式）

- `run_hooks()` 方法定义了关闭流程的骨架：
  - 锁定并提取所有注册钩子。
  - 并发执行所有钩子并等待完成。
- 具体关闭任务由各个钩子回调的异步实现完成。

---

## 工作原理

- 用户通过 `add_hook()` 注册异步钩子，传入返回 `Future` 的闭包。
- 收到终止信号（Ctrl-C）后，系统并发触发所有钩子。
- 各钩子异步执行，如关闭数据库连接、刷新日志等。
- 主程序循环保持运行，直到触发关闭。

---

## 设计优势

- **可扩展性：** 用户可自由添加任意数量异步钩子，无需修改核心逻辑。
- **低耦合：** 关闭系统不关心钩子内部实现，只负责触发。
- **并发性：** 钩子并行执行，缩短关闭总耗时。
- **安全性：** 合理的锁和异步机制避免竞态。

---

## 项目结构

```text
src/
├── main.rs          # 异步关闭钩子示例入口
